# Consensus

## Purpose
- 构建名为 RawViewer 的跨平台（macOS + Windows）原生 RAW 图像查看器
- 使用 Tauri v2（Rust 后端 + React 前端）作为技术栈
- 通过纯 Rust 的 rawler crate 解码主流品牌 RAW 文件（Canon/Nikon/Sony/Fuji 等），无 FFI 依赖
- 支持单文件打开（拖拽或菜单），提供缩放/平移/适应窗口基础查看能力
- 支持导出 JPEG（弹窗选画质：低/中/高）和直接导出 PNG（无画质弹窗）
- 显示基础元数据：文件名、图像尺寸、相机型号；加载大文件时显示进度动画；界面语言为中文
- Scope: rawviewer/ 目录及其所有子目录和文件，禁止触碰此目录之外的任何文件



## Rules
- 只允许修改 rawviewer/ 目录内的文件，禁止修改目录外任何文件
- 每个 todo 步骤完成后必须执行 cargo build 或 pnpm tauri dev 确认编译通过，编译失败则不得推进下一步
- 每个 todo 步骤必须通过实际运行 App 或可验证的输出进行验收，不得仅凭代码审查通过
- RAW 解码必须使用 rawler crate，禁止引入 C/C++ FFI 绑定库
- 前端必须使用 React，禁止替换为其他框架
- Tauri 版本锁定为 v2，禁止降级到 v1
- 缩放交互必须为鼠标滚轮，平移必须为拖拽，禁止添加额外按钮控件
- 导出 JPEG 必须弹窗让用户选择画质（低/中/高），导出 PNG 直接导出无弹窗



## Todo
- [ ] T001 在 rawviewer/ 目录下使用 `create-tauri-app` 初始化 Tauri v2 + React 项目，确认 package.json、src-tauri/Cargo.toml、src/App.tsx 存在
  - done_when: rawviewer/ 目录结构完整
  - done_when: 执行 pnpm tauri dev 能启动空白窗口且无报错
  - assist: codex
- [ ] T002 在 rawviewer/src-tauri/Cargo.toml 中添加 rawler、image crate 依赖，执行 cargo build 确认依赖下载和编译成功
  - done_when: Cargo.lock 中出现 rawler 条目
  - done_when: cargo build 零错误退出
  - assist: codex
- [ ] T003 在 rawviewer/src-tauri/src/ 中实现 Rust 命令 open_raw_file(path: String) -> Result<RawImageData, String>，使用 rawler 解码 RAW 文件并返回 RGB 像素数据、宽高、相机型号
  - done_when: 用真实 Canon 或 Sony RAW 文件调用该命令，返回正确宽高和相机型号
  - done_when: cargo test 中对该函数的单元测试通过
  - assist: claude
- [ ] T004 在 Tauri v2 中注册文件关联和拖拽事件，实现从菜单「打开文件」和拖拽 RAW 文件两种方式触发 open_raw_file 调用
  - done_when: 拖拽 RAW 文件到窗口触发 open_raw_file 调用
  - done_when: 菜单「打开文件」弹出文件选择器并触发 open_raw_file 调用
  - done_when: 两种方式均在控制台打印文件路径确认触发
  - assist: claude
- [ ] T005 在 rawviewer/src/App.tsx 中实现 Canvas 图像渲染组件，将 Rust 返回的 RGB 像素数据绘制到 HTML Canvas，图像加载完成后自动适应窗口大小
  - done_when: 打开 RAW 文件后 Canvas 正确显示图像
  - done_when: 图像初始状态适应窗口，无变形或空白区域
  - assist: claude
- [ ] T006 在 Canvas 组件上实现鼠标滚轮缩放（以鼠标位置为中心）和鼠标拖拽平移交互，不添加任何按钮控件
  - done_when: 滚轮向上缩放、向下缩小，中心点跟随鼠标位置
  - done_when: 鼠标按下拖拽可平移图像
  - done_when: 缩放比例在 10%~1000% 范围内限制
  - assist: claude
- [ ] T007 在 open_raw_file 调用期间，前端显示居中转圈加载动画（spinner），解码完成后隐藏；对 50MB+ 文件通过 Tauri event 发送进度百分比并更新进度条
  - done_when: 打开 50MB+ RAW 文件时界面显示进度条且数值递增
  - done_when: 解码完成后进度条和 spinner 消失，图像正常显示
  - assist: claude
- [ ] T008 在图像显示界面左下角叠加显示基础元数据面板：文件名、图像尺寸（宽x高像素）、相机型号，语言为中文标签
  - done_when: 打开任意 RAW 文件后元数据面板显示正确的文件名、尺寸和相机型号
  - done_when: 文字可读，不遮挡图像核心区域
  - assist: claude
- [ ] T009 实现「导出 JPEG」功能：点击菜单「导出 > JPEG」弹出画质选择弹窗（低 60/中 80/高 95），用户确认后调用 Rust image crate 编码并弹出保存路径选择器
  - done_when: 三种画质选项均可导出 JPEG 文件
  - done_when: 导出文件用图像软件打开确认画质差异可见
  - done_when: 导出文件字节数低/中/高递增
  - assist: claude
- [ ] T010 实现「导出 PNG」功能：点击菜单「导出 > PNG」直接弹出保存路径选择器，无画质弹窗，使用 image crate 无损导出
  - done_when: 导出 PNG 文件可正常打开
  - done_when: PNG 文件为无损格式，与原 RAW 分辨率一致
  - done_when: 无任何画质或压缩级别弹窗出现
  - assist: codex
- [ ] T011 使用至少 4 个品牌（Canon CR2/CR3、Nikon NEF、Sony ARW、Fuji RAF）的真实 RAW 文件进行端到端测试：打开、显示、缩放、平移、导出 JPEG 和 PNG 全流程
  - done_when: 4 个品牌 RAW 文件均能正确显示图像
  - done_when: 每个文件导出 JPEG 和 PNG 均成功
  - done_when: 元数据面板显示正确相机型号
  - assist: auto
- [ ] T012 分别在 macOS 和 Windows 环境执行 pnpm tauri build 生成发布包（macOS .dmg，Windows .msi），安装后打开 RAW 文件验证全部功能正常
  - done_when: macOS .dmg 安装后 App 可启动并完成 T011 全部验证项
  - done_when: Windows .msi 安装后 App 可启动并完成 T011 全部验证项
  - done_when: 两平台构建日志无 warning 等级以上错误
  - assist: auto

## Bot Status
- GE initialized and waiting for first execution.
- 19:21:58 GE initialized.

- 19:32:14 T001 codex review blocked by confirm.

- 21:44:57 T001 codex review reported blockers.

## Bot Journal
- 19:21:58 consensus planner: consensus generated by claude
- 19:32:14 T001 codex review blocked by confirm.
- 21:44:57 T001 codex review reported blockers.
